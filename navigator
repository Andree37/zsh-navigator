#!/usr/bin/env bash

base_dir="$HOME/github"
navigator_mode=${NAVIGATOR_MODE:-tmux} # Default to tmux mode if NAVIGATOR_MODE is unset
workspace_src_structure=${NAVIGATOR_SRC_STRUCTURE:-false} # Default to false if NAVIGATOR_SRC_STRUCTURE is unset

if [[ "$workspace_src_structure" == true ]]; then
    find_depth=(-mindepth 2 -maxdepth 3 -type d -path "*/src/*")
    awk_field='{print $(NF)"("$(NF-2)")"}'
else
    find_depth=(-mindepth 2 -maxdepth 2 -type d)
    awk_field='{print $(NF)"("$(NF-1)")"}'
fi

selected=$(find "$base_dir" "${find_depth[@]}" | awk -F '/' "$awk_field" | sort -u | fzf)

if [[ -z $selected ]]; then
    echo "No selection made."
    exit 0
fi

package=$(echo "$selected" | sed -E 's|\((.*)\)||' | xargs)
project=$(echo "$selected" | sed -E 's|.*\((.*)\)|\1|' | xargs)

if [[ "$workspace_src_structure" == true ]]; then
    package_path="$base_dir/$project/src/$package"
else
    package_path="$base_dir/$project/$package"
fi

if [[ ! -d $package_path ]]; then
    echo "Error: Package directory not found: $package_path"
    exit 1
fi

if [[ "$navigator_mode" == "tmux" ]]; then
    # TMUX
    session_name=$(echo "${project}_${package}" | tr . _)
    tmux_running=$(pgrep tmux)

    if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
        tmux new-session -s "$session_name" -c "$package_path"
        exit 0
    fi

    if ! tmux has-session -t="$session_name" 2> /dev/null; then
        tmux new-session -ds "$session_name" -c "$package_path"
    fi

    tmux switch-client -t "$session_name"
else
    # CD
    cd "$package_path" && clear || {
        echo "Failed to change directory to: $package_path"
        exit 1
    }
fi
